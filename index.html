<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Calculateur de Prix – Lavage à pression</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-gray-50">
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;

    function CalculateurPrix() {
      const [piedsCarres, setPiedsCarres] = useSyncedNumber("pw_sqft", 2800);
      const [tauxBase, setTauxBase] = useSyncedNumber("pw_baserate", 1.25);
      const [ajustPct, setAjustPct] = useSyncedNumber("pw_adjust", 0);

      const [nbSacs, setNbSacs] = useSyncedNumber("pw_bagcount", 25);
      const [prixSac, setPrixSac] = useSyncedNumber("pw_bagprice", 44);
      const [coutDivers, setCoutDivers] = useSyncedNumber("pw_bleachmisc", 25);

      const [carburant, setCarburant] = useSyncedNumber("pw_fuel", 60);
      const [usure, setUsure] = useSyncedNumber("pw_wear", 90);

      const [heures, setHeures] = useSyncedNumber("pw_hours", 18);
      const [tauxHoraire, setTauxHoraire] = useSyncedNumber("pw_rate", 75);

      const prixRapide = useMemo(() => {
        const base = piedsCarres * tauxBase;
        const aj = base * (ajustPct / 100);
        return clampMoney(base + aj);
      }, [piedsCarres, tauxBase, ajustPct]);

      const materiaux = useMemo(() => clampMoney(nbSacs * prixSac + coutDivers), [nbSacs, prixSac, coutDivers]);
      const exploitation = useMemo(() => clampMoney(carburant + usure), [carburant, usure]);
      const mainOeuvre = useMemo(() => clampMoney(heures * tauxHoraire), [heures, tauxHoraire]);

      const coutBase = useMemo(() => clampMoney(materiaux + exploitation + mainOeuvre), [materiaux, exploitation, mainOeuvre]);
      const marge40 = useMemo(() => clampMoney(coutBase * 1.4), [coutBase]);
      const prixRapide40 = useMemo(() => clampMoney(prixRapide * 1.4), [prixRapide]);

      const resetAll = () => {
        if (!confirm("Réinitialiser toutes les valeurs ?")) return;
        localStorage.clear();
        location.reload();
      };

      const chargerExemple = () => {
        setPiedsCarres(2800);
        setTauxBase(1.25);
        setAjustPct(0);
        setNbSacs(25);
        setPrixSac(44);
        setCoutDivers(25);
        setCarburant(60);
        setUsure(90);
        setHeures(18);
        setTauxHoraire(75);
      };

      return (
        <div className="mx-auto max-w-6xl p-6 md:p-10">
          <header className="mb-6 flex flex-col gap-3 md:flex-row md:items-end md:justify-between">
            <div>
              <h1 className="text-2xl md:text-3xl font-bold">Calculateur de Prix – Lavage à pression</h1>
              <p className="text-sm text-gray-600">Opérateur seul • Formule au pied carré + détails • Affiche coût de base et +40% marge</p>
            </div>
            <div className="flex gap-2">
              <button onClick={chargerExemple} className="px-3 py-2 rounded-xl bg-white shadow border">Charger exemple</button>
              <button onClick={resetAll} className="px-3 py-2 rounded-xl bg-white shadow border">Réinitialiser</button>
            </div>
          </header>

          <section className="mb-8 grid grid-cols-1 gap-4 md:grid-cols-12">
            <Card className="md:col-span-8">
              <h2 className="text-lg font-semibold mb-4">Calcul rapide au pied carré</h2>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <NumField label="Pieds carrés" value={piedsCarres} setValue={setPiedsCarres} step={50} />
                <MoneyField label="Taux de base ($ / pi²)" value={tauxBase} setValue={setTauxBase} step={0.05} />
                <RangeField label="Ajustement (%)" value={ajustPct} setValue={setAjustPct} min={-50} max={50} />
              </div>
              <hr className="my-4"/>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <Stat label="Prix rapide" value={toMoney(prixRapide)} />
                <Stat label="Rapide +40%" value={toMoney(prixRapide40)} highlight />
              </div>
            </Card>
            <Card className="md:col-span-4">
              <h3 className="font-semibold mb-3">Guide de taux</h3>
              <ul className="list-disc pl-5 text-sm">
                <li>Lavage léger : 0,60–0,90 $ / pi²</li>
                <li>Lavage + sable polymère : 1,10–1,50 $ / pi²</li>
                <li>Restauration lourde / taches : 1,50–2,25 $ / pi²</li>
              </ul>
            </Card>
          </section>

          <section className="mb-8">
            <h2 className="text-lg font-semibold mb-4">Détails du calcul</h2>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
              <Card>
                <h3 className="font-semibold mb-3">Matériaux</h3>
                <NumField label="Nb sacs sable polymère" value={nbSacs} setValue={setNbSacs} />
                <MoneyField label="Prix par sac ($)" value={prixSac} setValue={setPrixSac} />
                <MoneyField label="Eau de javel & divers ($)" value={coutDivers} setValue={setCoutDivers} />
                <Total label="Sous-total" value={materiaux} />
              </Card>
              <Card>
                <h3 className="font-semibold mb-3">Coûts d'exploitation</h3>
                <MoneyField label="Carburant ($)" value={carburant} setValue={setCarburant} />
                <MoneyField label="Usure équipement ($)" value={usure} setValue={setUsure} />
                <Total label="Sous-total" value={exploitation} />
              </Card>
              <Card>
                <h3 className="font-semibold mb-3">Main-d'œuvre</h3>
                <NumField label="Heures" value={heures} setValue={setHeures} />
                <MoneyField label="Taux horaire ($)" value={tauxHoraire} setValue={setTauxHoraire} />
                <Total label="Sous-total" value={mainOeuvre} />
              </Card>
            </div>
          </section>

          <section className="grid grid-cols-1 md:grid-cols-3 gap-6">
            <Card>
              <h3 className="font-semibold mb-2">Coût de base</h3>
              <p className="text-3xl font-bold">{toMoney(coutBase)}</p>
            </Card>
            <Card>
              <h3 className="font-semibold mb-2">Prix +40%</h3>
              <p className="text-3xl font-bold">{toMoney(marge40)}</p>
            </Card>
          </section>
        </div>
      );
    }

    function Card({ children, className }) {return <div className={\`bg-white rounded-xl shadow p-4 \${className}\`}>{children}</div>;}

    function Stat({ label, value, highlight }) {return <div className={\`p-4 rounded-xl border \${highlight?'bg-green-50 border-green-200':'bg-gray-50'}\`}><div className="text-xs">{label}</div><div className="text-2xl font-bold">{value}</div></div>;}

    function Total({ label, value }) {return <div className="mt-4 border-t pt-2 flex justify-between text-sm"><span>{label}</span><span className="font-bold">{toMoney(value)}</span></div>;}

    function NumField({ label, value, setValue, step=1 }) {return <label className="text-sm block">{label}<input type="number" value={value} step={step} onChange={e=>setValue(Number(e.target.value))} className="w-full border rounded p-1"/></label>;}

    function MoneyField({ label, value, setValue, step=1 }) {return <label className="text-sm block">{label}<input type="number" value={value} step={step} onChange={e=>setValue(Number(e.target.value))} className="w-full border rounded p-1"/></label>;}

    function RangeField({ label, value, setValue, min=-50, max=50 }) {return <label className="text-sm block">{label} {value}%<input type="range" min={min} max={max} value={value} onChange={e=>setValue(Number(e.target.value))} className="w-full"/></label>;}

    function toMoney(n){return n.toLocaleString(undefined,{style:'currency',currency:'CAD',maximumFractionDigits:0});}
    function clampMoney(n){return Math.max(0,Math.round(n*100)/100);}
    function useSyncedNumber(key, initial){const [val,setVal]=useState(()=>Number(localStorage.getItem(key))||initial);useEffect(()=>localStorage.setItem(key,val),[val]);return [val,setVal];}

    ReactDOM.createRoot(document.getElementById('root')).render(<CalculateurPrix/>);
  </script>
</body>
</html>